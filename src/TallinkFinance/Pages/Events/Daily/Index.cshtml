@page "/Events/{eventId:int}/Daily"
@model TallinkFinance.Pages.Events.Daily.IndexModel
@{
    ViewData["Title"] = "Daily View";
}

@if (Model.EventItem is null)
{
    <div class="alert alert-warning">Event not found.</div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-0">Daily View - @Model.EventItem.Name</h1>
            <div class="text-muted">Expenses, payments and net position change per day</div>
        </div>
        <a class="btn btn-outline-secondary" asp-page="/Events/Details" asp-route-id="@Model.EventItem.Id">Dashboard</a>
    </div>

    <form method="get" class="card shadow-sm mb-3">
        <div class="card-body">
            <input type="hidden" name="eventId" value="@Model.EventItem.Id" />
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label" for="dateFrom">From</label>
                    <input id="dateFrom" name="dateFrom" type="date" value="@Model.DateFrom?.ToString("yyyy-MM-dd")" class="form-control" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label" for="dateTo">To</label>
                    <input id="dateTo" name="dateTo" type="date" value="@Model.DateTo?.ToString("yyyy-MM-dd")" class="form-control" />
                </div>
            </div>
        </div>
        <div class="card-footer d-flex gap-2">
            <button type="submit" class="btn btn-primary">Apply Filters</button>
            <a class="btn btn-outline-secondary" asp-page="/Events/Daily/Index" asp-route-eventId="@Model.EventItem.Id">Reset</a>
        </div>
    </form>

    @if (Model.Days.Any())
    {
        @foreach (var day in Model.Days)
        {
            <div class="card shadow-sm mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>@day.Date.ToString("yyyy-MM-dd")</strong>
                    <div class="small text-muted">
                        Expenses: @day.ExpenseTotal.ToString("0.00") @Model.EventItem.Currency |
                        Payments: @day.PaymentTotal.ToString("0.00") @Model.EventItem.Currency
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12 col-xl-5">
                            <h2 class="h6">Expenses</h2>
                            @if (day.Expenses.Any())
                            {
                                <ul class="list-group list-group-flush">
                                    @foreach (var expense in day.Expenses)
                                    {
                                        <li class="list-group-item d-flex justify-content-between px-0">
                                            <div>
                                                <a asp-page="/Events/Expenses/Details" asp-route-eventId="@Model.EventItem.Id" asp-route-expenseId="@expense.ExpenseId">
                                                    @expense.Title
                                                </a>
                                                <div class="small text-muted">Paid by @expense.PayerName</div>
                                            </div>
                                            <span>@expense.Amount.ToString("0.00") @Model.EventItem.Currency</span>
                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="text-muted mb-0">No expenses.</p>
                            }
                        </div>

                        <div class="col-12 col-xl-4">
                            <h2 class="h6">Payments</h2>
                            @if (day.Payments.Any())
                            {
                                <ul class="list-group list-group-flush">
                                    @foreach (var payment in day.Payments)
                                    {
                                        <li class="list-group-item d-flex justify-content-between px-0">
                                            <div>
                                                <div>@payment.FromName -> @payment.ToName</div>
                                                <div class="small text-muted">@(string.IsNullOrWhiteSpace(payment.Note) ? "-" : payment.Note)</div>
                                            </div>
                                            <span>@payment.Amount.ToString("0.00") @Model.EventItem.Currency</span>
                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="text-muted mb-0">No payments.</p>
                            }
                        </div>

                        <div class="col-12 col-xl-3">
                            <h2 class="h6">Net Change</h2>
                            @if (day.Changes.Any())
                            {
                                <ul class="list-group list-group-flush">
                                    @foreach (var change in day.Changes)
                                    {
                                        <li class="list-group-item d-flex justify-content-between px-0">
                                            <span>@change.PersonName</span>
                                            <span class="@(change.Delta >= 0 ? "text-success" : "text-danger")">
                                                @change.Delta.ToString("+#,##0.00;-#,##0.00;0.00") @Model.EventItem.Currency
                                            </span>
                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="text-muted mb-0">No net changes.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info">No daily data for selected range.</div>
    }
}
